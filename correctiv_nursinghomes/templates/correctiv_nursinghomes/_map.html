{% load i18n %}
{% load sekizai_tags %}
{% load leaflet_tags %}

<header class="custom-leaflet-map">

  <div class="custom-leaflet-map__container">
    <header class="custom-leaflet-map__header">
      <a href="{% url 'nursinghomes:nursinghomes-index' %}">
        <h1 class="custom-leaflet-map__app-title">
          {% trans "Nursing Home Guide" %}
        </h1>
      </a>
      <h2 class="custom-leaflet-map__title">
        {{ object.name }}
      </h2>
      <p class="custom-leaflet-map__subtitle">
        {{ object.provider_type }}
      </p>
    </header>
  </div>

  {% leaflet_map "nursinghomes" %}

  {% addtoblock "css" %}
    {% leaflet_css %}
  {% endaddtoblock %}

  {% addtoblock "js" %}
    {% leaflet_js %}
  {% endaddtoblock %}

  {% addtoblock "js" %}
    <script>
      window.addEventListener("map:init", function (event) {
        var map = event.detail.map
        var items = {{ closest_nursinghomes|safe }}
        var currentItem = items.filter(function(item) {
          return item.current
        })[0]

        var Icon = L.Icon.extend({
          options: {
            iconSize: [18, 30],
            iconAnchor: [9, 26]
          }
        })

        var defaultIcon = new Icon({
          iconUrl: '/static/correctiv_nursinghomes/img/map-marker.svg'
        })

        var hilightIcon = new Icon({
          iconUrl: '/static/correctiv_nursinghomes/img/map-marker--hilight.svg'
        })

        // Apply custom marker icons:
        items.forEach(function(item) {
          var coordinates = item.latlng.coordinates.reverse()
          var icon = item.current ? hilightIcon : defaultIcon
          var marker = L.marker(coordinates, {icon: icon})
          marker.addTo(map)
        })

        // Additional map config:
        map.zoomControl.setPosition('topright')
        map.scrollWheelZoom.disable()
        map.setView(currentItem.latlng.coordinates, 12)


        // Offset the map to make space for the title:
        if (document.documentElement.clientWidth < 768) {
          map.panBy(new L.Point(0, 60), {animate: false})
        } else {
          map.panBy(new L.Point(-250, 0), {animate: false})
        }
      })
    </script>
  {% endaddtoblock %}

</header>
